<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="css/estilo.css"/>
    <link rel="stylesheet" href="css/banda.css"/>
    <title>Document</title>
</head>
<body>
    <header>
        <nav>
            <a href="index.html" class="header__logo"> <h2>SEMPITERNAL</h2> </a>
            <ul class="header__nav logado">
                <li><a href="index.html" class="navbar__items__options">Home</a></li>
                <li><a href="navigation.html" class="navbar__items__options">Bandas</a></li>
                <li><a href="profile.html" class="navbar__items__options">Perfil</a></li>
                <li> <button onclick="Logout()">Sair</button> </li>
            </ul>
        </nav>
    </header>
    <main>
        <section class="band__banner" id="banner-placeholder">
            <div class="band__header">
                <div class="band__tags title__icon">
                    <h1 class="band__title" id="band-name-placeholder"></h1>
                    <button id="favorite-band-button" onclick="FavoritarBanda()">
                        <img src="" alt="Star icon." id="favorite-icon-placeholder">
                    </button>
                </div>
                <div class="band__tags">
                    <span class="tag ranking" id="ranking-placeholder"></span>
                    <span class="tag genre" id="genre-placeholder"></span>
                </div>
            </div>
        </section>
        
        <nav class="band__nav">
            <button class="nav__item" id="nav-about" onclick="ExibirSobre()">SOBRE</button>
            <button class="nav__item" id="nav-albuns" onclick="ExibirAlbuns()">ÁLBUNS</button>
        </nav>
        
        <section class="band__content">
            <div id="sobre">
                <h2 class="section__title">HISTÓRIA</h2>
                <p class="band__bio" id="bio-placeholder"></p>
            </div>
            
            <div id="albuns"></div>
        </section>
    </main>
    <footer>
        <div class="footer__container">
            <div class=" footer__identidade">
                <a href="index.html"> <h2 class="footer__logo">SEMPITERNAL</h2> </a>
                <div class="footer__social">
                    <a href="https://www.linkedin.com/in/strilicherk/" class="social__link">
                        <img src="assets/icons/LinkedIn.png" alt="LinkedIn"> 
                        <span>LinkedIn</span>
                    </a>
                    <a href="https://github.com/Strilicherk" class="social__link">
                        <img src="assets/icons/GitHub.png" alt="GitHub"> 
                        <span>GitHub</span>
                    </a>
                </div>
            </div>
            
            <nav class="footer__nav">
                <ul class="footer__items">
                    <li><a href="register.html">Cadastre-se</a></li>
                    <li><a href="login.html">Login</a></li>
                    <li><a href="navigation.html">Bandas</a></li>
                </ul>
            </nav>
            
            <div class="footer__legal">
                <p>Todos os direitos (não) reservados.</p>
                <p>Um projeto de faculdade.</p>
            </div>
        </div>
    </footer>
    
    <script>
        var bandaInfos;
        var bandasRanking;
        
        document.getElementById('nav-about').classList.add('active');
        
        window.onload = async function() {
            var idBanda = new URLSearchParams(window.location.search).get('id');
            // idUsuario = sessionStorage.ID_USUARIO;
            var idUsuario = 1;
            
            try {
                var resposta;
                
                resposta = await fetch(`/bandas/buscarRanking`);
                
                if (resposta.ok) {
                    bandasRanking = await resposta.json();
                } else {
                    console.log('Erro ao trazer ranking')
                }
                
                resposta = await fetch(`/bandas/buscar/${idBanda}?idUsuario=${idUsuario}`)
                
                if (resposta.ok) {
                    bandaInfos = await resposta.json();
                    console.log(bandaInfos);
                } else {
                    console.log('Erro ao trazer as informações da banda')
                }
                
                PopularCampos();
            } catch (resposta) {
                console.log(`#ERRO: ${resposta}`);
            }
        }
        
        function ExibirSobre() {
            document.getElementById('sobre').style.display = 'flex';
            document.getElementById('albuns').style.display = 'none';
            document.getElementById('nav-about').classList.add('active');
            document.getElementById('nav-albuns').classList.remove('active');
        }
        
        function ExibirAlbuns() {
            document.getElementById('sobre').style.display = 'none';
            document.getElementById('albuns').style.display = 'flex';
            document.getElementById('nav-about').classList.remove('active');
            document.getElementById('nav-albuns').classList.add('active');
        }
        
        function PopularCampos() {
            document.getElementById('banner-placeholder').style.backgroundImage = `url('${bandaInfos.banner_path}')`;
            document.getElementById('band-name-placeholder').innerText = bandaInfos.band;
            document.getElementById('favorite-icon-placeholder').src = bandaInfos.is_favorite_band ? '../assets/icons/FilledStar.png' : '../assets/icons/EmptyStar.png';
            
            for (var i = 0; i < bandasRanking.length; i++) {
                if (bandasRanking[i].band_id == bandaInfos.band_id) {
                    ranking = i + 1;
                    break;
                }
            }
            
            document.getElementById('ranking-placeholder').innerText = `Ranking #${ranking}`;
            if (ranking == 1) {
                document.getElementById('ranking-placeholder').classList.add('gold')
            } else if (ranking >= 2 && ranking <= 5) {
                document.getElementById('ranking-placeholder').classList.add('silver')
            } else {
                document.getElementById('ranking-placeholder').classList.add('bronze')
            }
            
            document.getElementById('genre-placeholder').innerText = bandaInfos.genre;
            document.getElementById('bio-placeholder').innerText = bandaInfos.about;
            
            if (bandaInfos.albums.length > 0) {
                RenderizarAlbuns(bandaInfos.albums);
            } else {
                document.getElementById('albuns').innerHTML = "<h3>Nenhum álbum encontrado.</h3>";
            }
        }
        
        function RenderizarAlbuns(listaDeAlbuns) {
            var htmlGeral = "";
            
            for (var i = 0; i < listaDeAlbuns.length; i++) {
                var album = listaDeAlbuns[i];
                var htmlMusicas = "";
                
                for (var j = 0; j < album.musics.length; j++) {
                    var musica = album.musics[j];
                    var likeIcon = musica.is_liked ? '../assets/icons/FilledLike.png' : '../assets/icons/EmptyLike.png';
                    var favoriteIcon = musica.is_favorite_music ? '../assets/icons/FilledStar.png' : '../assets/icons/EmptyStar.png';
                    
                    htmlMusicas += `
                        <div class="music__row">
                            <div class="music__left">
                                <span class="music__number">${j + 1}</span>
                                <span class="music__name">${musica.music}</span>
                                <span class="music__mood mood__${musica.mood.toLowerCase()}">${musica.mood}</span> 
                            </div>
                            
                            <div class="music__actions">
                                <button class="btn-like" onclick="CurtirMusica(${musica.music_id})" id ="like-button-${musica.music_id}">
                                    <img class="interactive__icon" src="${likeIcon}" id="like-icon-${musica.music_id}">
                                </button>
                                <button onclick="FavoritarMusica(${musica.music_id})" id ="favorite-button-${musica.music_id}">
                                    <img class="interactive__icon star-music" src="${favoriteIcon}" id="favorite-icon-${musica.music_id}">
                                </button>
                            </div>
                        </div>
                    `;
                }          
                
                htmlGeral += `
                    <details>
                        <summary>
                            <img src="${album.album_cover_path}" alt="Capa ${album.album}" class="album__cover">
                            <div class="album__info">
                                <h2>${album.album}</h2>
                                <span class="album__year">${album.album_release_date}</span>
                            </div>
                        </summary>
                        
                        <div class="album__musics__list">
                            ${htmlMusicas} 
                        </div>
                    </details>
                `;
            }
            
            document.getElementById('albuns').innerHTML = htmlGeral;
        }
        
        function CurtirMusica(id) {
            var botao = document.getElementById(`like-button-${id}`);
            
            if (botao.disabled) {
                return; 
            } else {
                botao.disabled = true;
            }
            
            var elemento = document.getElementById(`like-icon-${id}`);
            var musicaCurtida = elemento.src.endsWith('FilledLike.png');
            elemento.src = musicaCurtida ? '../assets/icons/EmptyLike.png' : '../assets/icons/FilledLike.png';
            
            // var idUsuario = sessionStorage.ID_USUARIO; 
            var idUsuario = 1;
            console.log(musicaCurtida);
            fetch("/musicas/curtir", {
                method: "POST",
                headers: {
                    "Content-Type": "application/json",
                },
                body: JSON.stringify({
                    musicIdServer: id,
                    userIdServer: idUsuario,
                    acao: musicaCurtida ? 'descurtir' : 'curtir'
                }),
            })
            .then(function (resposta) {
                if (resposta.ok)  {
                    console.log("Like atualizado no banco");
                } else {
                    console.log("Erro ao atualizar like");
                }
            }).catch(function (resposta) {
                console.log(`#ERRO: ${resposta}`);
            }).finally(() => {
                botao.disabled = false;
            });
        }
        
        function FavoritarMusica(id) {
            var botao = document.getElementById(`favorite-button-${id}`);
            
            if (botao.disabled) {
                return; 
            } else {
                botao.disabled = true;
            }
            
            var elemento = document.getElementById(`favorite-icon-${id}`);
            var musicaFavorita = elemento.src.endsWith('FilledStar.png');

            if (!musicaFavorita) {
                var favoritoAnterior = document.querySelector('.star-music[src$="FilledStar.png"]');
                
                if (favoritoAnterior && favoritoAnterior.id !== elemento.id) {
                    favoritoAnterior.src = '../assets/icons/EmptyStar.png';
                }
            }
            
            elemento.src = musicaFavorita ? '../assets/icons/EmptyStar.png' : '../assets/icons/FilledStar.png';
            
            // var idUsuario = sessionStorage.ID_USUARIO; 
            var idUsuario = 1;
            
            fetch("/musicas/favoritar", {
                method: "POST",
                headers: {
                    "Content-Type": "application/json",
                },
                body: JSON.stringify({
                    idUserServer: idUsuario,
                    idMusicServer: musicaFavorita ? null : id,
                    
                }),
            }).then (function (resposta) {
                console.log(resposta)
                if (resposta.ok) {
                    
                } else {
                    elemento.src = musicaFavorita ? '../assets/icons/FilledStar.png' : '../assets/icons/EmptyStar.png';
                }
            }).catch(function (resposta) {
                elemento.src = musicaFavorita ? '../assets/icons/FilledStar.png' : '../assets/icons/EmptyStar.png';
                console.log(`#ERRO: ${resposta}`);
            }).finally(function() {
                botao.disabled = false;
            });
        }
        
        function FavoritarBanda() {
            var id = bandaInfos.band_id;
            var botao = document.getElementById('favorite-band-button');
            
            if (botao.disabled) {
                return; 
            } else {
                botao.disabled = true;
            }
            
            var elemento = document.getElementById('favorite-icon-placeholder');
            var bandaFavorita = elemento.src.endsWith('FilledStar.png');            
            elemento.src = bandaFavorita ? '../assets/icons/EmptyStar.png' : '../assets/icons/FilledStar.png';
            
            // var idUsuario = sessionStorage.ID_USUARIO; 
            var idUsuario = 1;
            
            fetch("/bandas/favoritar", {
                method: "POST",
                headers: {
                    "Content-Type": "application/json",
                },
                body: JSON.stringify({
                    idUserServer: idUsuario,
                    idBandServer: bandaFavorita ? null : id,
                    
                }),
            }).then (function (resposta) {
                console.log(resposta)
                if (resposta.ok) {
                    
                } else {
                    elemento.src = bandaFavorita ? '../assets/icons/FilledStar.png' : '../assets/icons/EmptyStar.png';
                }
            }).catch(function (resposta) {
                elemento.src = bandaFavorita ? '../assets/icons/FilledStar.png' : '../assets/icons/EmptyStar.png';
                console.log(`#ERRO: ${resposta}`);
            }).finally(function() {
                botao.disabled = false;
            });
        }

    </script>
</body>
</html>