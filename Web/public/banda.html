<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="css/estilo.css"/>
    <link rel="stylesheet" href="css/banda.css"/>
    <script src="js/componentes.js"></script>
    <title>Bandas</title>
</head>
<body>
    <header id="header-placeholder"></header>
    <main>
        <section class="band__banner" id="banner-placeholder">
            <div class="band__header">
                <div class="band__tags title__icon">
                    <h1 class="band__title" id="band-name-placeholder"></h1>
                    <button id="favorite-band-button" onclick="FavoritarBanda()">
                        <img src="" alt="Star icon." id="favorite-icon-placeholder">
                    </button>
                </div>
                <div class="band__tags">
                    <span class="tag ranking" id="ranking-placeholder"></span>
                    <span class="tag genre" id="genre-placeholder"></span>
                </div>
            </div>
        </section>
        
        <nav class="band__nav">
            <button class="nav__item" id="nav-about" onclick="ExibirSobre()">SOBRE</button>
            <button class="nav__item" id="nav-albuns" onclick="ExibirAlbuns()">ÁLBUNS</button>
        </nav>
        
        <section class="band__content">
            <div id="sobre">
                <h2 class="section__title">HISTÓRIA</h2>
                <p class="band__bio" id="bio-placeholder"></p>
            </div>
            
            <div id="albuns"></div>
        </section>
    </main>
    <footer id="footer-placeholder"></footer>
    
    <script>
        CarregarHeader();
        CarregarFooter();
        
        var bandaInfos;
        var bandasRanking;
        
        document.getElementById('nav-about').classList.add('active');
        
        window.onload = async function() {
            idUsuario = localStorage.ID_USUARIO;
            
            if (idUsuario == undefined) {
                window.location.href = 'cadastro.html';
                return;
            }
            
            var idBanda = new URLSearchParams(window.location.search).get('id');
            
            try {
                var resposta;
                
                resposta = await fetch(`/bandas/buscarRankingBandas`);
                
                if (resposta.ok) {
                    bandasRanking = await resposta.json();
                } else {
                    var erro = await resposta.json();
                    console.log(erro);
                    MostrarFeedback(erro, false);
                }
                
                resposta = await fetch(`/bandas/buscarBandaPorId/${idBanda}?idUsuario=${idUsuario}`)
                
                if (resposta.ok) {
                    bandaInfos = await resposta.json();
                } else {
                    var erro = await resposta.json();
                    console.log(erro);
                    MostrarFeedback(erro, false);
                }
                
                PopularCampos();
            } catch (erro) {
                console.log(erro);
                MostrarFeedback(erro, false);
            }
            
        }
        
        function ExibirSobre() {
            document.getElementById('sobre').style.display = 'flex';
            document.getElementById('albuns').style.display = 'none';
            document.getElementById('nav-about').classList.add('active');
            document.getElementById('nav-albuns').classList.remove('active');
        }
        
        function ExibirAlbuns() {
            document.getElementById('sobre').style.display = 'none';
            document.getElementById('albuns').style.display = 'flex';
            document.getElementById('nav-about').classList.remove('active');
            document.getElementById('nav-albuns').classList.add('active');
        }
        
        function PopularCampos() {
            document.getElementById('banner-placeholder').style.backgroundImage = `url('${bandaInfos.banner_path}')`;
            document.getElementById('band-name-placeholder').innerText = bandaInfos.band;
            document.getElementById('favorite-icon-placeholder').src = bandaInfos.is_favorite_band ? '../assets/icons/FilledStar.png' : '../assets/icons/EmptyStar.png';
            
            for (var i = 0; i < bandasRanking.length; i++) {
                if (bandasRanking[i].band_id == bandaInfos.band_id) {
                    ranking = i + 1;
                    break;
                }
            }
            
            document.getElementById('ranking-placeholder').innerText = `Ranking #${ranking}`;
            if (ranking == 1) {
                document.getElementById('ranking-placeholder').classList.add('gold')
            } else if (ranking >= 2 && ranking <= 5) {
                document.getElementById('ranking-placeholder').classList.add('silver')
            } else {
                document.getElementById('ranking-placeholder').classList.add('bronze')
            }
            
            document.getElementById('genre-placeholder').innerText = bandaInfos.genre;
            document.getElementById('bio-placeholder').innerText = bandaInfos.about;
            
            if (bandaInfos.albums.length > 0) {
                RenderizarAlbuns(bandaInfos.albums);
            } else {
                document.getElementById('albuns').innerHTML = "<h3>Nenhum álbum encontrado.</h3>";
            }
        }
        
        function RenderizarAlbuns(listaDeAlbuns) {
            var htmlGeral = "";
            
            for (var i = 0; i < listaDeAlbuns.length; i++) {
                var album = listaDeAlbuns[i];
                var htmlMusicas = "";
                
                for (var j = 0; j < album.musics.length; j++) {
                    var musica = album.musics[j];
                    var likeIcon = musica.is_liked ? '../assets/icons/FilledLike.png' : '../assets/icons/EmptyLike.png';
                    var favoriteIcon = musica.is_favorite_music ? '../assets/icons/FilledStar.png' : '../assets/icons/EmptyStar.png';
                    
                    htmlMusicas += `
                        <div class="music__row">
                            <div class="music__left">
                                <span class="music__number">${j + 1}</span>
                                <span class="music__name">${musica.music}</span>
                                <span class="music__mood mood__${musica.mood.toLowerCase()}">${musica.mood}</span> 
                            </div>
                            
                            <div class="music__actions">
                                <button class="btn-like" onclick="CurtirMusica(${musica.music_id})" id ="like-button-${musica.music_id}">
                                    <img class="interactive__icon" src="${likeIcon}" id="like-icon-${musica.music_id}">
                                </button>
                                <button onclick="FavoritarMusica(${musica.music_id})" id ="favorite-button-${musica.music_id}">
                                    <img class="interactive__icon star-music" src="${favoriteIcon}" id="favorite-icon-${musica.music_id}">
                                </button>
                            </div>
                        </div>
                    `;
                }          
                
                htmlGeral += `
                    <details>
                        <summary>
                            <img src="${album.album_cover_path}" alt="Capa ${album.album}" class="album__cover">
                            <div class="album__info">
                                <h2>${album.album}</h2>
                                <span class="album__year">${album.album_release_date}</span>
                            </div>
                        </summary>
                        
                        <div class="album__musics__list">
                            ${htmlMusicas} 
                        </div>
                    </details>
                `;
            }
            
            document.getElementById('albuns').innerHTML = htmlGeral;
        }
        
        function CurtirMusica(id) {
            var botao = document.getElementById(`like-button-${id}`);
            
            if (botao.disabled) {
                return; 
            } else {
                botao.disabled = true;
            }
            
            var idUsuario = localStorage.ID_USUARIO;
            var elemento = document.getElementById(`like-icon-${id}`);
            var musicaCurtida = elemento.src.endsWith('FilledLike.png');
            elemento.src = musicaCurtida ? '../assets/icons/EmptyLike.png' : '../assets/icons/FilledLike.png';
            
            
            fetch("/musicas/curtirMusica", {
                method: "POST",
                headers: {
                    "Content-Type": "application/json",
                },
                body: JSON.stringify({
                    musicIdServer: id,
                    userIdServer: idUsuario,
                    acao: musicaCurtida ? 'descurtir' : 'curtir'
                }),
            }).then(async function (resposta) {
                if (!resposta.ok) {
                    var mensagemErro = await resposta.json();
                    MostrarFeedback(mensagemErro, false);
                }
            }).catch(function (erro) {
                MostrarFeedback("Erro de conexão ou falha na API.", false);
            }).finally(() => {
                botao.disabled = false;
            });
        }
        
        function FavoritarMusica(id) {
            var botao = document.getElementById(`favorite-button-${id}`);
            
            if (botao.disabled) {
                return; 
            } else {
                botao.disabled = true;
            }
            
            var elemento = document.getElementById(`favorite-icon-${id}`);
            var musicaFavorita = elemento.src.endsWith('FilledStar.png');
            
            if (!musicaFavorita) {
                var favoritoAnterior = document.querySelector('.star-music[src$="FilledStar.png"]');
                
                if (favoritoAnterior && favoritoAnterior.id !== elemento.id) {
                    favoritoAnterior.src = '../assets/icons/EmptyStar.png';
                }
            }
            
            elemento.src = musicaFavorita ? '../assets/icons/EmptyStar.png' : '../assets/icons/FilledStar.png';
            
            var idUsuario = localStorage.ID_USUARIO;
            
            fetch("/usuarios/favoritarMusica", {
                method: "POST",
                headers: {
                    "Content-Type": "application/json",
                },
                body: JSON.stringify({
                    idUserServer: idUsuario,
                    idMusicServer: musicaFavorita ? null : id,
                    
                }),
            }).then (async function (resposta) {
                if (!resposta.ok) {
                    elemento.src = musicaFavorita ? '../assets/icons/FilledStar.png' : '../assets/icons/EmptyStar.png';
                    var erro = await resposta.json();
                    MostrarFeedback(erro, false);
                }
            }).catch(function (resposta) {
                elemento.src = musicaFavorita ? '../assets/icons/FilledStar.png' : '../assets/icons/EmptyStar.png';
                MostrarFeedback("Erro de conexão. Tente novamente.", false);
            }).finally(function() {
                botao.disabled = false;
            });
        }
        
        function FavoritarBanda() {
            var id = bandaInfos.band_id;
            var botao = document.getElementById('favorite-band-button');
            
            if (botao.disabled) {
                return; 
            } else {
                botao.disabled = true;
            }
            
            var elemento = document.getElementById('favorite-icon-placeholder');
            var bandaFavorita = elemento.src.endsWith('FilledStar.png');            
            elemento.src = bandaFavorita ? '../assets/icons/EmptyStar.png' : '../assets/icons/FilledStar.png';
            
            var idUsuario = localStorage.ID_USUARIO;
            
            fetch("/usuarios/favoritarBanda", {
                method: "POST",
                headers: {
                    "Content-Type": "application/json",
                },
                body: JSON.stringify({
                    idUserServer: idUsuario,
                    idBandServer: bandaFavorita ? null : id,
                    
                }),
            }).then (async function (resposta) {
                if (!resposta.ok) {
                    elemento.src = bandaFavorita ? '../assets/icons/FilledStar.png' : '../assets/icons/EmptyStar.png';
                    var erro = await resposta.json();
                    MostrarFeedback(erro, false);
                }
            }).catch(function (resposta) {
                elemento.src = bandaFavorita ? '../assets/icons/FilledStar.png' : '../assets/icons/EmptyStar.png';
                MostrarFeedback("Erro de conexão. Tente novamente.", false);
            }).finally(function() {
                botao.disabled = false;
            });
        }
    </script>
    
    <div id="modal-global" style="display: none;"></div>
</body>
</html>