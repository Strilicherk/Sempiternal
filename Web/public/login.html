<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <link rel="stylesheet" href="css/estilo.css">
    <link rel="stylesheet" href="css/cadastro_login.css">
    <script src="./js/sessao.js"></script>
    <title>Sempiternal - Login</title>
</head>
<body>
    <header>
        <nav>
            <a href="index.html" class="header__logo"> <h2>SEMPITERNAL</h2> </a>
            <div class="header__nav">
                <div class="ranking__banda">
                    <ul class="navbar__items">
                        <li><a href="navegacao.html" class="navbar__items__options">Bandas</a></li>
                    </ul>
                </div>
                <div class="login__cadastro">
                    <ul class="navbar__items">
                        <li>
                            <a href="login.html" class="navbar__items__options">LOGIN</a>
                        </li>
                        <li>
                            <a href="cadastro.html" class="navbar__items__options"><span class="botao">CADASTRE-SE</span></a>
                        </li>
                    </ul>
                </div>
            </div>
        </nav>
    </header>
    
    <main>
        <div id="modal__card" class="modal__error"></div>
        <div class="auth__card">
            <div class="auth__tabs">
                <a href="cadastro.html" class="tab__link">CADASTRO</a>
                <a href="login.html" class="tab__link tab__active">LOGIN</a>
            </div>
            
            <form class="form__group">
                <div class="input__box">
                    <label for="input__email__login">Email</label>
                    <input type="email" id="input__email__login" placeholder="voce@email.com" oninput="ValidarEmailLogin(input__email__login.value)">
                    <span id="msg__email__login__erro" class="msg__error">Use um email válido: Gmail, Outlook, Yahoo ou Hotmail.</span>
                </div>
                
                <div class="input__box">
                    <label for="input__senha__login">Senha</label>
                    <input type="password" id="input__senha__login" placeholder="••••••" oninput="ValidarSenhaLogin(input__senha__login.value)">
                    <span id="msg__senha__login__erro" class="msg__error">Digite sua senha para entrar.</span>
                </div>
                
                <a href="#" class="forgot__password">Esqueceu a senha?</a>
                
                <button type="button" class="btn__form" onclick="Entrar(input__email__login.value, input__senha__login.value)">ENTRAR</button>
            </form>
        </div>
    </main>
    
    <script>
        function ValidarEmailLogin(email) {
            email = email.toLowerCase();
            var emailLoginValido = false;
            
            var provedoresPermitidos = [
            "@gmail.com", 
            "@hotmail.com", 
            "@outlook.com", 
            "@yahoo.com",
            ];
            
            for (var i = 0; i < provedoresPermitidos.length; i++) {
                var provedor = provedoresPermitidos[i];
                if (email.endsWith(provedor)) {
                    msg__email__login__erro.style.display = 'none';
                    return true;
                }
            }
            
            msg__email__login__erro.style.display = 'block';
            return false;
        }
        
        function ValidarSenhaLogin(senha) {
            if (senha.length < 1) {
                msg__senha__login__erro.style.display = 'block';
                return false;
            }

            msg__senha__login__erro.style.display = 'none';
            return true;
        }
        
        function MostrarFeedback(mensagem) {
            modal__card.innerHTML = mensagem;
            modal__card.style.display = "block";
            
            if (funcionou == false) {
                setTimeout(() => {
                    modal__card.style.display = "none";
                }, 5000);
            }
        }

        function ValidarCredenciais(email, senha) {
            console.log("FORM LOGIN: ", email);
            console.log("FORM SENHA: ", senha);
            
            fetch("/usuarios/autenticar", {
                method: "POST",
                headers: {
                    "Content-Type": "application/json"
                },
                body: JSON.stringify({
                    emailServer: email,
                    senhaServer: senha
                })
            })
            .then(function (resposta) {
                console.log("ESTOU NO THEN DO entrar()!")
                
                if (resposta.ok) {
                    console.log(resposta);
                    
                    resposta.json().then(json => {
                        console.log(json);
                        console.log(JSON.stringify(json));
                        console.log()
                        sessionStorage.ID_USUARIO = json.id;
                        sessionStorage.NICKNAME = json.nickname;

                        window.location = "home.html";
                    });
                    
                } else {

                    console.log("Houve um erro ao tentar realizar o login!");
                    
                    resposta.text().then(texto => {
                        console.error(texto);
                        MostrarFeedback(texto)
                    });
                }
                
            }).catch(function (erro) {
                MostrarFeedback(erro)
                console.log(erro);
            })
            
            return false;
        }
        

        function Entrar(email, senha) {            
            if (ValidarEmailLogin(email) && ValidarSenhaLogin(senha)) {
                ValidarCredenciais(email, senha)
            }
        }
        
    </script>
</body>
</html>