<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <link rel="stylesheet" href="css/estilo.css">
    <link rel="stylesheet" href="css/cadastro_login.css">
    <script src="js/componentes.js"></script>
    <title>Login</title>
</head>
<body>
    <header id="header-placeholder"></header>
    
    <main>
        <div id="modal__card" class="modal__error"></div>
        <div class="auth__card">
            <div class="auth__tabs">
                <a href="cadastro.html" class="tab__link">CADASTRO</a>
                <a href="login.html" class="tab__link tab__active">LOGIN</a>
            </div>
            
            <form class="form__group">
                <div class="input__box">
                    <label for="input__email__login">Email</label>
                    <input type="email" id="input__email__login" placeholder="voce@email.com" oninput="ValidarEmailLogin(input__email__login.value)">
                    <span id="msg__email__login__erro" class="msg__error">Use um email válido: Gmail, Outlook, Yahoo ou Hotmail.</span>
                </div>
                
                <div class="input__box">
                    <label for="input__senha__login">Senha</label>
                    <input type="password" id="input__senha__login" placeholder="••••••" oninput="ValidarSenhaLogin(input__senha__login.value)">
                    <span id="msg__senha__login__erro" class="msg__error">Digite sua senha para entrar.</span>
                </div>
                
                <a href="#" class="forgot__password">Esqueceu a senha?</a>
                
                <button type="button" class="btn__form" onclick="Entrar(input__email__login.value, input__senha__login.value)">ENTRAR</button>
            </form>
        </div>
    </main>
    
    <script>
        CarregarHeader();
        
        function ValidarEmailLogin(email) {
            email = email.toLowerCase();
            var emailLoginValido = false;
            var provedoresPermitidos = ["@gmail.com", "@hotmail.com", "@outlook.com", "@yahoo.com",];
            
            for (var i = 0; i < provedoresPermitidos.length; i++) {
                var provedor = provedoresPermitidos[i];
                if (email.endsWith(provedor)) {
                    msg__email__login__erro.style.display = 'none';
                    return true;
                }
            }
            
            msg__email__login__erro.style.display = 'block';
            return false;
        }
        
        function ValidarSenhaLogin(senha) {
            if (senha.length < 1) {
                msg__senha__login__erro.style.display = 'block';
                return false;
            }
            
            msg__senha__login__erro.style.display = 'none';
            return true;
        }
        
        function ValidarCredenciais(email, senha) {
            fetch("/usuarios/autenticarUsuario", {
                method: "POST",
                headers: {
                    "Content-Type": "application/json"
                },
                body: JSON.stringify({
                    emailServer: email,
                    senhaServer: senha
                })
            }).then(function (resposta) {
                if (resposta.ok) {
                    resposta.json().then(json => {
                        localStorage.ID_USUARIO = json.id
                        localStorage.NICKNAME = json.nickname;
                        MostrarFeedback("Login bem sucedido. Redirecionando para a home page.", true)
                        window.location = "home.html";
                    });
                } else {
                    resposta.json().then(json => {
                        MostrarFeedback(json, false)
                    });
                }
            }).catch(function (erro) {
                MostrarFeedback(erro, false)
            })
            
            return false;
        }
        
        function Entrar(email, senha) {            
            if (ValidarEmailLogin(email) && ValidarSenhaLogin(senha)) {
                ValidarCredenciais(email, senha)
            }
        }  
    </script>
    
    <div id="modal-global" style="display: none;"></div>
</body>
</html>